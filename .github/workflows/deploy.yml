name: Deploy SoVoLo to EC2

on:
  push:
    branches:
      - main    # Infra ë ˆí¬ì˜ main ë¸Œëœì¹˜ê°€ í‘¸ì‹œë  ë•Œ ìë™ ì‹¤í–‰

jobs:
  deploy:
    name: Deploy via SSH
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Infra Repository
        uses: actions/checkout@v4

      - name: SSH into EC2 and deploy
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            set -e

            echo "ğŸ”¹ Moving to SoVoLo directory"
            cd ~/sovolo

            echo "ğŸ”¹ Pulling latest changes for all repos"
            cd Backend && git fetch --all && git reset --hard origin/main && cd ..
            cd Frontend && git fetch --all && git reset --hard origin/main && cd ..
            cd Chatbot && git fetch --all && git reset --hard origin/main && cd ..
            cd Infra && git fetch --all && git reset --hard origin/main

            echo "ğŸ”¹ Starting Docker Compose (prod)"
            cd Infra
            docker compose -f docker-compose.prod.yml --env-file .env.prod build
            docker compose -f docker-compose.prod.yml --env-file .env.prod up -d

            echo "âœ… Deployment completed successfully"
